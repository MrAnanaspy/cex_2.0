<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-hint {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .parameters-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .parameter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .parameter-name {
            flex: 1;
        }

        .parameter-value {
            flex: 2;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-full {
            width: 100%;
        }

        .footer {
            padding: 20px 40px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-info {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .btn-group {
            display: flex;
            gap: 15px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .parameter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-group {
                flex-direction: column;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—Ä–µ–∑—ã</h1>
            <p>–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–π —Ñ—Ä–µ–∑–µ –≤ –∫–∞—Ç–∞–ª–æ–≥</p>
        </div>

        <div class="content">
            <div class="form-section">
                <h2 class="section-title">–ü–∞—Ä—Å–∏–Ω–≥ —Å –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∞–π—Ç–∞</h2>
                <div class="form-group">
                    <label class="form-label" for="external-url">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞ –≤–Ω–µ—à–Ω–µ–º —Å–∞–π—Ç–µ</label>
                    <input type="url" name="href" id="external-url" class="form-input" placeholder="https://example.com/tool">
                    <div class="form-hint">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <button id="parse-btn" class="btn btn-primary">
                    <span>üì•</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–∞–π—Ç–∞
                </button>
                <div id="parse-result"></div>
            </div>

            <div class="form-section">
                <h2 class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                <div class="form-group">
                    <label class="form-label" for="tool-name">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ *</label>
                    <input type="text" id="tool-name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="tool-description">–û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ *</label>
                    <textarea id="tool-description" class="form-textarea" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="tool-name">–ö–æ–¥ –º–æ–Ω–æ–ª–∏—Ç–∞ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ </label>
                    <input type="text" id="monolit-code" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞" required>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h2>
                <img id="preview" src="" height="300" style="display: none; margin-bottom: 15px; max-width: 100%; border-radius: 8px;">
                <div class="form-group">
                    <label class="form-label" for="photo-url">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</label>
                    <input type="text" id="photo-url" class="form-input" placeholder="https://example.com/images/tool.jpg">
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–ª–∏—á–∏–µ</h2>
                <div class="form-group">
                    <label class="form-label" for="tool-quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                    <input type="number" id="tool-quantity" class="form-input" value="0" min="0">
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
                <div class="parameters-container">
                    <div class="attributes-container">
                        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è parameter-row -->
                    </div>
                    <button id="add-param-btn" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-info">
                * - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" id="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</button>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showAlert(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            document.querySelectorAll('.alert').forEach(alert => alert.remove());

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ content
            document.querySelector('.content').prepend(alertDiv);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        function addParameterRow(container, key = '', value = '') {
            const parameterRow = document.createElement('div');
            parameterRow.className = 'parameter-row';

            parameterRow.innerHTML = `
                <div class="parameter-name">
                    <input type="text" class="form-input param-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞" value="${key}">
                </div>
                <div class="parameter-value">
                    <input type="text" class="form-input param-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞" value="${value}">
                </div>
                <button class="btn btn-danger btn-sm remove-param" type="button">
                    <span>üóëÔ∏è</span>
                </button>
            `;

            parameterRow.querySelector('.remove-param').addEventListener('click', function() {
                parameterRow.remove();
            });

            container.appendChild(parameterRow);
        }

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        function initAttributes(attributes, containerSelector) {
            const container = document.querySelector(containerSelector);
            Object.entries(attributes).forEach(([key, value]) => {
                addParameterRow(container, key, value);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞)
        function collectFormData() {
            const name = document.getElementById('tool-name').value.trim();
            const description = document.getElementById('tool-description').value.trim();
            const monolit = document.getElementById('monolit-code').value.trim();
            const photoUrl = document.getElementById('photo-url').value.trim();
            const quantity = parseInt(document.getElementById('tool-quantity').value) || 0;
            const externalUrl = document.getElementById('external-url').value.trim();

            // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
            const attributes = {};
            const parameterRows = document.querySelectorAll('.attributes-container .parameter-row');

            parameterRows.forEach(row => {
                const keyInput = row.querySelector('.param-name');
                const valueInput = row.querySelector('.param-value');
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                if (key && value) {
                    attributes[key] = value;
                }
            });

            return {
                name: name,
                description: description,
                monolit: monolit,
                url: externalUrl,  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±—ã–ª–æ url, —Ç–µ–ø–µ—Ä—å externalUrl
                image_url: photoUrl,
                quantity: quantity,
                attributes: attributes  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –±—ã–ª–æ parameters, —Ç–µ–ø–µ—Ä—å attributes
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
        async function saveTool() {
            const formData = collectFormData();

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!formData.name) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                document.getElementById('tool-name').focus();
                return;
            }

            if (!formData.description) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                document.getElementById('tool-description').focus();
                return;
            }

            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerHTML;

            try {
                saveBtn.innerHTML = '<span>‚è≥</span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                saveBtn.disabled = true;

                const response = await fetch('/tool/add/mill/', { // –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById('tool-name').value = '';
                    document.getElementById('tool-description').value = '';
                    document.getElementById('photo-url').value = '';
                    document.getElementById('tool-quantity').value = '0';
                    document.getElementById('external-url').value = ''; // –î–û–ë–ê–í–õ–ï–ù–û: –æ—á–∏—Å—Ç–∫–∞ URL
                    document.querySelector('.attributes-container').innerHTML = '';
                    document.getElementById('preview').style.display = 'none';

                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        window.location.href = result.redirect_url || '/tools/';
                    }, 2000);
                } else {
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }

            } catch (error) {
                console.error('Network error:', error);
                showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ö–Ω–æ–ø–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
            document.getElementById('parse-btn').addEventListener('click', async function() {
                const urlInput = document.getElementById('external-url');
                const resultDiv = document.getElementById('parse-result');
                const button = this;

                const externalUrl = urlInput.value.trim();

                if (!externalUrl) {
                    showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL');
                    return;
                }

                try {
                    button.innerHTML = '<span>‚è≥</span> –ó–∞–≥—Ä—É–∑–∫–∞...';
                    button.disabled = true;
                    resultDiv.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';

                    const response = await fetch('/tools/parse/', { // –ò–∑–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({
                            url: externalUrl
                        })
                    });

                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();

                        if (data.success) {
                            resultDiv.innerHTML = `<div style="color: green;">–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!</div>`;

                            document.getElementById("tool-name").value = data.data.title || '';
                            document.getElementById("tool-description").value = data.data.description || '';

                            const photoUrl = data.data.img || '';
                            document.getElementById("photo-url").value = photoUrl;

                            const preview = document.getElementById("preview");
                            if (photoUrl) {
                                preview.src = photoUrl;
                                preview.style.display = 'block';
                            }

                            if (data.data.attributes) {
                                document.querySelector('.attributes-container').innerHTML = '';
                                initAttributes(data.data.attributes, '.attributes-container');
                            }

                        } else {
                            resultDiv.innerHTML = `<div style="color: red;">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                        }
                    } else {
                        const text = await response.text();
                        throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç');
                    }

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', error);
                    resultDiv.innerHTML = `<div style="color: red;">${error.message}</div>`;
                } finally {
                    button.innerHTML = '<span>üì•</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–∞–π—Ç–∞';
                    button.disabled = false;
                }
            });

            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            document.getElementById('add-param-btn').addEventListener('click', function() {
                addParameterRow(document.querySelector('.attributes-container'));
            });

            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            document.getElementById('save-btn').addEventListener('click', saveTool);

            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
            document.getElementById('cancel-btn').addEventListener('click', function() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞?')) {
                    window.location.href = '/tools/';
                }
            });

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ URL —Ñ–æ—Ç–æ
            document.getElementById('photo-url').addEventListener('input', function() {
                const preview = document.getElementById('preview');
                const url = this.value.trim();

                if (url) {
                    preview.src = url;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>